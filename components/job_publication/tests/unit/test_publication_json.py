from datetime import datetime

from ....common.python.database.model.job.fsc_rlie_job import FscRlieJob


def test_publication_json_setup():
    """Test that publication JSONs are correctly filled."""

    json_template = {
        "collection_name": "HR-S&I",
        "resto": {
            "type": "Feature",
            "geometry": {
                "wkt": None
            },
            "properties": {
                "productIdentifier": None,
                "title": None,
                "resourceSize": None,
                "organisationName": "EEA",
                "startDate": None,
                "completionDate": None,
                "productType": None,
                "resolution": None,
                "mission": None,
                "cloudCover": None,
                "processingBaseline": None,
                "host_base": "s3.waw2-1.cloudferro.com",
                "s3_bucket": None,
                "thumbnail": None
                }
            }
        }

    fsc_reference_filled_json = {'collection_name': 'HR-S&I', 'resto': {'type': 'Feature', 'geometry': {'wkt': 'POLYGON ((20.99964726638503 59.45052513518552, 20.99964380464058 59.77918552493646, 20.9996402623421 60.10782936577433, 20.99963663682669 60.43645676755113, 21.41023086437871 60.43582546845951, 21.82078808090701 60.43392944525661, 22.23127126336018 60.43076903632944, 22.23123052563337 60.42969184411896, 22.23118979103627 60.42861465171661, 22.23114905956853 60.42753745912232, 22.22961498235818 60.42539648705663, 22.22808110835074 60.42325549605349, 22.22654743750181 60.42111448611745, 22.19913444950881 60.3868819248087, 22.1717793095768 60.35264339007485, 22.14448181833762 60.31839890509939, 22.12329837798195 60.29199959704538, 22.10214927173038 60.2655967196181, 22.08103440857426 60.23919028350463, 21.99842071246968 60.13567297043924, 21.91632732178725 60.03210155905104, 21.83474887255069 59.92847668102714, 21.76397876695857 59.83838901720657, 21.69359163590858 59.74826153914963, 21.62358406527773 59.65809465098764, 21.58582370657431 59.60941752639896, 21.54817277438436 59.56072902428983, 21.51063074326875 59.51202920713255, 21.49622200891882 59.49340602693972, 21.48182918084137 59.47478118674875, 21.46745222985902 59.45615469005207, 21.46602133752362 59.45472297579857, 21.46459056637245 59.45329124541253, 21.46315991638906 59.45185949889667, 21.46173917964781 59.451146114417, 21.46031850274533 59.45043271433818, 21.4588978856787 59.44971929866154, 21.30581751448496 59.45016725739085, 21.15273334015831 59.45043587180615, 20.99964726638503 59.45052513518552))'}, 'properties': {'productIdentifier': '/eodata/HRSI/CLMS/Pan-European/High_Resolution_Layers/Snow/FSC/2021/04/13/FSC_20210413T101347_S2A_T34VEM_V100_1', 'title': 'FSC_20210413T101347_S2A_T34VEM_V100_1', 'resourceSize': 2134016, 'organisationName': 'EEA', 'startDate': '2021-04-13T10:13:47.668204', 'completionDate': '2021-04-13T14:53:50.579313', 'productType': 'FSC', 'resolution': 20, 'mission': 'S2', 'cloudCover': '86.0', 'processingBaseline': 'V100', 'host_base': 's3.waw2-1.cloudferro.com', 's3_bucket': 'HRSI', 'thumbnail': 'Preview/CLMS/Pan-European/High_Resolution_Layers/Snow/FSC/2021/04/13/FSC_20210413T101347_S2A_T34VEM_V100_1/thumbnail.png'}}}
    rlie_reference_filled_json = {'collection_name': 'HR-S&I', 'resto': {'type': 'Feature', 'geometry': {'wkt': 'POLYGON ((20.99964726638503 59.45052513518552, 20.99964380464058 59.77918552493646, 20.9996402623421 60.10782936577433, 20.99963663682669 60.43645676755113, 21.41023086437871 60.43582546845951, 21.82078808090701 60.43392944525661, 22.23127126336018 60.43076903632944, 22.23123052563337 60.42969184411896, 22.23118979103627 60.42861465171661, 22.23114905956853 60.42753745912232, 22.22961498235818 60.42539648705663, 22.22808110835074 60.42325549605349, 22.22654743750181 60.42111448611745, 22.19913444950881 60.3868819248087, 22.1717793095768 60.35264339007485, 22.14448181833762 60.31839890509939, 22.12329837798195 60.29199959704538, 22.10214927173038 60.2655967196181, 22.08103440857426 60.23919028350463, 21.99842071246968 60.13567297043924, 21.91632732178725 60.03210155905104, 21.83474887255069 59.92847668102714, 21.76397876695857 59.83838901720657, 21.69359163590858 59.74826153914963, 21.62358406527773 59.65809465098764, 21.58582370657431 59.60941752639896, 21.54817277438436 59.56072902428983, 21.51063074326875 59.51202920713255, 21.49622200891882 59.49340602693972, 21.48182918084137 59.47478118674875, 21.46745222985902 59.45615469005207, 21.46602133752362 59.45472297579857, 21.46459056637245 59.45329124541253, 21.46315991638906 59.45185949889667, 21.46173917964781 59.451146114417, 21.46031850274533 59.45043271433818, 21.4588978856787 59.44971929866154, 21.30581751448496 59.45016725739085, 21.15273334015831 59.45043587180615, 20.99964726638503 59.45052513518552))'}, 'properties': {'productIdentifier': '/eodata/HRSI/CLMS/Pan-European/High_Resolution_Layers/Ice/RLIE/2021/04/13/RLIE_20210413T101347_S2A_T34VEM_V100_1', 'title': 'RLIE_20210413T101347_S2A_T34VEM_V100_1', 'resourceSize': 421888, 'organisationName': 'EEA', 'startDate': '2021-04-13T10:13:47.668204', 'completionDate': '2021-04-13T14:53:50.579313', 'productType': 'RLIE', 'resolution': 20, 'mission': 'S2', 'cloudCover': '86.0', 'processingBaseline': 'V100', 'host_base': 's3.waw2-1.cloudferro.com', 's3_bucket': 'HRSI', 'thumbnail': 'Preview/CLMS/Pan-European/High_Resolution_Layers/Ice/RLIE/2021/04/13/RLIE_20210413T101347_S2A_T34VEM_V100_1/thumbnail.png'}}}

    # Define the FscRlie job
    job = FscRlieJob(
        id = 179555,
        l1c_sensing_time = "2021-04-13T10:13:47.668204",
        fsc_infos = '{ "collection_name": "HR-S&I", "resto": { "type": "Feature", "geometry": { "wkt": "POLYGON ((20.99964726638503 59.45052513518552, 20.99964380464058 59.77918552493646, 20.9996402623421 60.10782936577433, 20.99963663682669 60.43645676755113, 21.41023086437871 60.43582546845951, 21.82078808090701 60.43392944525661, 22.23127126336018 60.43076903632944, 22.23123052563337 60.42969184411896, 22.23118979103627 60.42861465171661, 22.23114905956853 60.42753745912232, 22.22961498235818 60.42539648705663, 22.22808110835074 60.42325549605349, 22.22654743750181 60.42111448611745, 22.19913444950881 60.3868819248087, 22.1717793095768 60.35264339007485, 22.14448181833762 60.31839890509939, 22.12329837798195 60.29199959704538, 22.10214927173038 60.2655967196181, 22.08103440857426 60.23919028350463, 21.99842071246968 60.13567297043924, 21.91632732178725 60.03210155905104, 21.83474887255069 59.92847668102714, 21.76397876695857 59.83838901720657, 21.69359163590858 59.74826153914963, 21.62358406527773 59.65809465098764, 21.58582370657431 59.60941752639896, 21.54817277438436 59.56072902428983, 21.51063074326875 59.51202920713255, 21.49622200891882 59.49340602693972, 21.48182918084137 59.47478118674875, 21.46745222985902 59.45615469005207, 21.46602133752362 59.45472297579857, 21.46459056637245 59.45329124541253, 21.46315991638906 59.45185949889667, 21.46173917964781 59.451146114417, 21.46031850274533 59.45043271433818, 21.4588978856787 59.44971929866154, 21.30581751448496 59.45016725739085, 21.15273334015831 59.45043587180615, 20.99964726638503 59.45052513518552))" }, "properties": { "productIdentifier": "FSC_20210413T101347_S2A_T34VEM_V100_1", "title": "FSC_20210413T101347_S2A_T34VEM_V100_1", "resourceSize": "2084", "organisationName": "EEA", "startDate": "2021-04-13T10:13:47.668204Z", "completionDate": "2021-04-13T10:13:47.668204Z", "productType": "FSC", "resolution": 20, "cloudCover": "86.0", "processingBaseline": "1", "host_base": null, "s3_bucket": null } } }',
        rlie_infos = '{ "collection_name": "HR-S&I", "resto": { "type": "Feature", "geometry": { "wkt": "POLYGON ((20.99964726638503 59.45052513518552, 20.99964380464058 59.77918552493646, 20.9996402623421 60.10782936577433, 20.99963663682669 60.43645676755113, 21.41023086437871 60.43582546845951, 21.82078808090701 60.43392944525661, 22.23127126336018 60.43076903632944, 22.23123052563337 60.42969184411896, 22.23118979103627 60.42861465171661, 22.23114905956853 60.42753745912232, 22.22961498235818 60.42539648705663, 22.22808110835074 60.42325549605349, 22.22654743750181 60.42111448611745, 22.19913444950881 60.3868819248087, 22.1717793095768 60.35264339007485, 22.14448181833762 60.31839890509939, 22.12329837798195 60.29199959704538, 22.10214927173038 60.2655967196181, 22.08103440857426 60.23919028350463, 21.99842071246968 60.13567297043924, 21.91632732178725 60.03210155905104, 21.83474887255069 59.92847668102714, 21.76397876695857 59.83838901720657, 21.69359163590858 59.74826153914963, 21.62358406527773 59.65809465098764, 21.58582370657431 59.60941752639896, 21.54817277438436 59.56072902428983, 21.51063074326875 59.51202920713255, 21.49622200891882 59.49340602693972, 21.48182918084137 59.47478118674875, 21.46745222985902 59.45615469005207, 21.46602133752362 59.45472297579857, 21.46459056637245 59.45329124541253, 21.46315991638906 59.45185949889667, 21.46173917964781 59.451146114417, 21.46031850274533 59.45043271433818, 21.4588978856787 59.44971929866154, 21.30581751448496 59.45016725739085, 21.15273334015831 59.45043587180615, 20.99964726638503 59.45052513518552))" }, "properties": { "productIdentifier": null, "title": "RLIE_20210413T101347_S2A_T34VEM_V100_1", "resourceSize": "412", "organisationName": "EEA", "startDate": "2021-04-13T10:13:47.668204Z", "completionDate": "2021-04-13T10:13:47.668204Z", "productType": "FSC", "resolution": 20, "cloudCover": "86.0", "processingBaseline": "1", "host_base": null, "s3_bucket": null } } }',
        fsc_path = "/eodata/HRSI/CLMS/Pan-European/High_Resolution_Layers/Snow/FSC/2021/04/13/FSC_20210413T101347_S2A_T34VEM_V100_1",
        rlie_path = "/eodata/HRSI/CLMS/Pan-European/High_Resolution_Layers/Ice/RLIE/2021/04/13/RLIE_20210413T101347_S2A_T34VEM_V100_1",
        fsc_completion_date = datetime.strptime("2021-04-13T14:53:50.579313", '%Y-%m-%dT%H:%M:%S.%f'),
        rlie_completion_date = datetime.strptime("2021-04-13T14:53:50.579313", '%Y-%m-%dT%H:%M:%S.%f'),
    )

    # Call the function to test
    fsc_filled_json, rlie_filled_json = job.get_products_publication_jsons(json_template)

    # Ensure the publication JSONs have been correctly filled
    assert fsc_filled_json == fsc_reference_filled_json
    assert rlie_filled_json == rlie_reference_filled_json
